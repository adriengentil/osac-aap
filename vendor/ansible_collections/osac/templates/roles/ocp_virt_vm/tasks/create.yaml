# The ComputeInstance Create Playbook in osac-aap pass in the following variables:
# compute_instance: Payload from EDA
# compute_instance_name: Name for the order.
# compute_instance_working_namespace: Private namespace created for the ComputeInstance
# template_id: Template Id string.
# template_parameters: All template variables passed.  Defined in arguement_specs.yaml
# default_arg_specs: default values for arguement_specs
---
- name: Merge template defaults into template_parameters
  ansible.builtin.set_fact:
    params: "{{ default_arg_specs | combine(template_parameters) }}"

- name: Extract VM configuration from ComputeInstance spec
  ansible.builtin.set_fact:
    vm_cpu_cores: "{{ (compute_instance.spec.cores | default(default_spec.cores)) | int }}"
    vm_memory: "{{ (compute_instance.spec.memoryGiB | default(default_spec.memoryGiB)) | string + 'Gi' }}"
    vm_boot_disk_size: "{{ (compute_instance.spec.bootDisk.sizeGiB | default(default_spec.bootDisk.sizeGiB)) | string + 'Gi' }}"
    vm_image_source: "{{ compute_instance.spec.image.sourceRef | default(default_spec.image.sourceRef) }}"
    vm_run_strategy: "{{ compute_instance.spec.runStrategy | default(default_spec.runStrategy) }}"
    vm_ssh_key: "{{ compute_instance.spec.sshKey | default('') }}"
    vm_user_data_secret_ref: "{{ (compute_instance.spec.userDataSecretRef | default({})).name | default('') }}"
    vm_additional_disks: "{{ compute_instance.spec.additionalDisks | default([]) }}"
    vm_boot_disk_storage_class: "{{ compute_instance.spec.bootDisk.storageClass | default('') }}"

- name: Validate exposed_ports format
  ansible.builtin.assert:
    that:
      - params.exposed_ports is match('^([0-9]+/(tcp|udp))(,[0-9]+/(tcp|udp))*$')
    fail_msg: "exposed_ports must be in format 'port/protocol' (e.g., '22/tcp,80/tcp') where protocol is 'tcp' or 'udp'"

- name: Build template spec base
  ansible.builtin.set_fact:
    vm_template_spec:
      domain:
        cpu:
          cores: "{{ vm_cpu_cores }}"
        memory:
          guest: "{{ vm_memory }}"
        devices:
          disks:
            - name: root-disk
              disk:
                bus: virtio
          interfaces:
            - name: default
              masquerade: {}
          rng: {}
        features:
          smm:
            enabled: true
          acpi: {}
          apic: {}
          hyperv:
            relaxed: {}
            vapic: {}
            spinlocks:
              spinlocks: 8191
      networks:
        - name: default
          pod: {}
      volumes:
        - name: root-disk
          dataVolume:
            name: "{{ compute_instance_name }}-root-disk"

- name: Copy user-data secret to VM namespace and add cloud-init disk to template spec
  when: vm_user_data_secret_ref | length > 0
  block:
    - name: Read user-data secret from ComputeInstance namespace
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Secret
        name: "{{ vm_user_data_secret_ref }}"
        namespace: "{{ compute_instance.metadata.namespace }}"
      register: user_data_secret

    - name: Fail if user-data secret not found
      ansible.builtin.assert:
        that:
          - user_data_secret.resources | length > 0
        fail_msg: >-
          Secret '{{ vm_user_data_secret_ref }}' not found in namespace
          '{{ compute_instance.metadata.namespace }}'

    - name: Create user-data secret in VM namespace
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: "{{ compute_instance_name }}-user-data"
            namespace: "{{ compute_instance_working_namespace }}"
            labels: "{{ default_vm_labels }}"
          type: Opaque
          data: "{{ user_data_secret.resources[0].data }}"

    - name: Add cloud-init disk to template spec
      ansible.builtin.set_fact:
        vm_template_spec: "{{ vm_template_spec | combine(cloud_init_patch, recursive=True, list_merge='append') }}"
      vars:
        cloud_init_patch:
          domain:
            devices:
              disks:
                - name: cloud-init-disk
                  disk:
                    bus: virtio
                  serial: cloud-init
          volumes:
            - name: cloud-init-disk
              cloudInitNoCloud:
                secretRef:
                  name: "{{ compute_instance_name }}-user-data"

- name: Add minimal cloud-init disk for SSH key propagation
  ansible.builtin.set_fact:
    vm_template_spec: "{{ vm_template_spec | combine(cloud_init_patch, recursive=True, list_merge='append') }}"
  vars:
    cloud_init_patch:
      domain:
        devices:
          disks:
            - name: cloud-init-disk
              disk:
                bus: virtio
              serial: cloud-init
      volumes:
        - name: cloud-init-disk
          cloudInitNoCloud:
            userData: "#cloud-config"
  when:
    - vm_ssh_key | length > 0
    - vm_user_data_secret_ref | length == 0

- name: Create ssh public key secret and add accessCredentials to template spec
  when: vm_ssh_key | length > 0
  block:
    - name: Create Secret resource containing ssh public key
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: "{{ compute_instance_name }}-ssh-public-key"
            namespace: "{{ compute_instance_working_namespace }}"
            labels: "{{ default_vm_labels }}"
          data:
            ssh-public-key: "{{ vm_ssh_key | b64encode }}"
          type: Opaque

    - name: Add accessCredentials to template spec
      ansible.builtin.set_fact:
        vm_template_spec: "{{ vm_template_spec | combine(ssh_public_key_patch, recursive=True, list_merge='append') }}"
      vars:
        ssh_public_key_patch:
          accessCredentials:
            - sshPublicKey:
                source:
                  secret:
                    secretName: "{{ compute_instance_name }}-ssh-public-key"
                propagationMethod:
                  noCloud: {}

- name: Get the all StorageClasses
  kubernetes.core.k8s_info:
    api_version: storage.k8s.io/v1
    kind: StorageClass
  register: storage_classes

- name: Set default StorageClass
  ansible.builtin.set_fact:
    storage_class: "{{ item.metadata.name }}"
  loop: "{{ storage_classes.resources }}"
  when:
    - "'storageclass.kubernetes.io/is-default-class' in item.metadata.annotations"
    - item.metadata.annotations['storageclass.kubernetes.io/is-default-class'] | bool

- name: Override storage_class from spec, env var, or keep cluster default
  ansible.builtin.set_fact:
    storage_class: >-
      {{
        vm_boot_disk_storage_class
        | default(lookup('env', 'OSAC_VM_OPERATIONS_STORAGE_CLASS'), true)
        | default(storage_class, true)
      }}

- name: Using vmaas_storage_class
  ansible.builtin.debug:
    var: storage_class

- name: Create DataVolume for VM root disk
  kubernetes.core.k8s:
    apply: true
    definition:
      apiVersion: cdi.kubevirt.io/v1beta1
      kind: DataVolume
      metadata:
        name: "{{ compute_instance_name }}-root-disk"
        labels: "{{ default_vm_labels }}"
        namespace: "{{ compute_instance_working_namespace }}"
      spec:
        source:
          registry:
            url: "docker://{{ vm_image_source }}"
        pvc:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: "{{ vm_boot_disk_size }}"
          storageClassName: "{{ storage_class }}"
    state: present

- name: Create DataVolumes for additional disks
  kubernetes.core.k8s:
    apply: true
    definition:
      apiVersion: cdi.kubevirt.io/v1beta1
      kind: DataVolume
      metadata:
        name: "{{ compute_instance_name }}-disk-{{ idx + 1 }}"
        labels: "{{ default_vm_labels }}"
        namespace: "{{ compute_instance_working_namespace }}"
      spec:
        source:
          blank: {}
        pvc:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: "{{ item.sizeGiB }}Gi"
          storageClassName: "{{ item.storageClass | default(storage_class) }}"
    state: present
  loop: "{{ vm_additional_disks }}"
  loop_control:
    index_var: idx
  when: vm_additional_disks | length > 0

- name: Add additional disks to template spec
  ansible.builtin.set_fact:
    vm_template_spec: "{{ vm_template_spec | combine(additional_disk_patch, recursive=True, list_merge='append') }}"
  vars:
    additional_disk_patch:
      domain:
        devices:
          disks:
            - name: "additional-disk-{{ idx + 1 }}"
              disk:
                bus: virtio
      volumes:
        - name: "additional-disk-{{ idx + 1 }}"
          dataVolume:
            name: "{{ compute_instance_name }}-disk-{{ idx + 1 }}"
  loop: "{{ vm_additional_disks }}"
  loop_control:
    index_var: idx
  when: vm_additional_disks | length > 0

- name: Create VirtualMachine
  kubernetes.core.k8s:
    apply: true
    definition:
      apiVersion: kubevirt.io/v1
      kind: VirtualMachine
      metadata:
        name: "{{ compute_instance_name }}"
        namespace: "{{ compute_instance_working_namespace }}"
        labels: "{{ default_vm_labels }}"
      spec:
        runStrategy: "{{ vm_run_strategy }}"
        template:
          metadata:
            labels: "{{ default_vm_labels }}"
          spec: "{{ vm_template_spec }}"
    state: present

- name: Show VM Namespace and VM Name
  ansible.builtin.debug:
    msg: "Namespace {{ compute_instance_working_namespace }} - Name: {{ compute_instance_name }}"

- name: Wait for VM to be ready
  kubernetes.core.k8s_info:
    api_version: kubevirt.io/v1
    kind: VirtualMachine
    name: "{{ compute_instance_name }}"
    namespace: "{{ compute_instance_working_namespace }}"
    wait: true
    wait_condition:
      type: Ready
      status: "True"
    wait_timeout: 600
  when: vm_run_strategy != "Halted"

- name: Annotate the reconciledConfigVerion
  kubernetes.core.k8s:
    api_version: osac.openshift.io/v1alpha1
    kind: ComputeInstance
    name: "{{ compute_instance_name }}"
    namespace: "{{ compute_instance.metadata.namespace }}"
    state: present
    definition:
      metadata:
        annotations:
          osac.openshift.io/reconciled-config-version: "{{ compute_instance.status.desiredConfigVersion | default('unknown') }}"

- name: Get VM status
  kubernetes.core.k8s_info:
    api_version: kubevirt.io/v1
    kind: VirtualMachine
    name: "{{ compute_instance_name }}"
    namespace: "{{ compute_instance_working_namespace }}"
  register: vm_status

- name: Display VM information
  ansible.builtin.debug:
    msg:
      - "Virtual Machine '{{ compute_instance_name }}' created successfully"
      - "Namespace: {{ compute_instance_working_namespace }}"
      - "Image: {{ vm_image_source }}"
      - "CPU Cores: {{ vm_cpu_cores }}/Memory: {{ vm_memory }}"
      - "Root Disk Size: {{ vm_boot_disk_size }}"
      - "Additional Disks: {{ vm_additional_disks | length }}"
      - "RunStrategy: {{ vm_run_strategy }}"
      - "Status: {{ vm_status.resources[0].status.printableStatus | default('Unknown') }}"
